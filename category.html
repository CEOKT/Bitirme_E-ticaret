<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Kategori - Destifo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/products.css">
    <link rel="stylesheet" href="css/pages.css">
    <style>
        .category-page {
            padding: 30px 0;
        }

        .category-header {
            margin-bottom: 30px;
        }

        .category-header h1 {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .category-header p {
            color: #666;
            font-size: 15px;
        }

        /* Subcategory Chips */
        .subcategory-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .subcategory-chip {
            padding: 10px 20px;
            background: #f5f5f5;
            border-radius: 25px;
            color: #555;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .subcategory-chip:hover,
        .subcategory-chip.active {
            background: var(--secondary-color);
            color: white;
        }

        /* Main Layout */
        .category-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 30px;
        }

        /* Filter Sidebar */
        .filter-sidebar {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .filter-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .filter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .filter-section h4 {
            font-size: 15px;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--secondary-color);
        }

        .filter-option label {
            font-size: 14px;
            color: #555;
            cursor: pointer;
        }

        .price-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .price-inputs input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-btn {
            width: 100%;
            padding: 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .filter-btn:hover {
            background: #d35400;
        }

        /* Products Area */
        .products-area {
            min-height: 400px;
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .product-count {
            font-size: 14px;
            color: #666;
        }

        .sort-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Product Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .product-card .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .product-card .favorite-btn:hover {
            background: #fee;
        }

        .product-card .favorite-btn i {
            color: #e74c3c;
        }

        .product-card a {
            text-decoration: none;
            color: inherit;
        }

        .product-card .product-image {
            height: 200px;
            overflow: hidden;
        }

        .product-card .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .product-card:hover .product-image img {
            transform: scale(1.05);
        }

        .product-card .product-info {
            padding: 15px;
        }

        .product-card .product-brand {
            font-size: 12px;
            color: var(--secondary-color);
            font-weight: 600;
            text-transform: uppercase;
        }

        .product-card .product-name {
            font-size: 14px;
            font-weight: 500;
            margin: 8px 0;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-card .product-rating {
            font-size: 12px;
            color: #f39c12;
            margin-bottom: 8px;
        }

        .product-card .product-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .product-card .product-old-price {
            font-size: 13px;
            color: #999;
            text-decoration: line-through;
        }

        .product-card .add-cart-btn {
            width: calc(100% - 30px);
            margin: 0 15px 15px;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .product-card .add-cart-btn:hover {
            background: #1a3355;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 16px;
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .category-layout {
                grid-template-columns: 1fr;
            }

            .filter-sidebar {
                position: static;
            }
        }

        @media (max-width: 576px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .product-card .product-image {
                height: 150px;
            }

            .product-card .product-info {
                padding: 10px;
            }
        }
    </style>
</head>

<body>

    <!-- Fixed Header Wrapper -->
    <div class="fixed-header-wrapper">
        <!-- Header Section -->
        <header class="header">
            <div class="container header-inner">
                <div class="logo">
                    <a href="index.html"
                        style="display: flex; align-items: center; color: inherit; text-decoration: none;">
                        <img src="images/logo.png" alt="Destifo Logo" style="height: 40px; margin-right: 8px;">
                        <span class="logo-text">Destifo</span>
                    </a>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Ürün, kategori veya marka ara...">
                    <button type="submit" onclick="performSearch()"><i
                            class="fa-solid fa-magnifying-glass"></i></button>
                </div>

                <div class="header-actions">
                    <a href="account.html" class="action-item">
                        <i class="fa-solid fa-user"></i>
                        <span>Hesabım</span>
                    </a>
                    <a href="favorites.html" class="action-item">
                        <i class="fa-solid fa-heart"></i>
                        <span>Favorilerim</span>
                    </a>
                    <a href="cart.html" class="action-item">
                        <div class="cart-icon-wrapper">
                            <i class="fa-solid fa-cart-shopping"></i>
                            <span class="cart-count">0</span>
                        </div>
                        <span>Sepetim</span>
                    </a>
                </div>
            </div>
        </header>
    </div>

    <!-- Breadcrumbs -->
    <div class="breadcrumbs container">
        <a href="index.html">Anasayfa</a> <i class="fa-solid fa-chevron-right"></i>
        <span id="breadcrumb-parent"></span>
        <span class="current" id="breadcrumb-current">Kategori</span>
    </div>

    <!-- Category Page Content -->
    <section class="category-page container">
        <div class="category-header">
            <h1 id="category-title">Tüm Ürünler</h1>
            <p id="category-description">Kategorideki tüm ürünleri keşfedin</p>
        </div>

        <!-- Subcategory Chips -->
        <div class="subcategory-chips" id="subcategoryChips">
            <!-- Subcategories will be loaded here -->
        </div>

        <div class="category-layout">
            <!-- Filter Sidebar -->
            <aside class="filter-sidebar">
                <div class="filter-section">
                    <h4>Alt Kategori</h4>
                    <div id="subCategoryFilters">
                        <!-- Will be loaded -->
                    </div>
                </div>

                <div class="filter-section">
                    <h4>Marka</h4>
                    <div id="brandFilters">
                        <!-- Will be loaded -->
                    </div>
                </div>

                <div class="filter-section">
                    <h4>Fiyat Aralığı</h4>
                    <div class="price-inputs">
                        <input type="number" id="minPrice" placeholder="Min TL">
                        <input type="number" id="maxPrice" placeholder="Max TL">
                    </div>
                    <button class="filter-btn" onclick="applyPriceFilter()">Uygula</button>
                </div>
            </aside>

            <!-- Products Area -->
            <div class="products-area">
                <div class="products-header">
                    <span class="product-count" id="productCount">0 ürün</span>
                    <select class="sort-select" id="sortSelect" onchange="sortProducts()">
                        <option value="recommended">Önerilen</option>
                        <option value="price-low">Fiyat (Düşük-Yüksek)</option>
                        <option value="price-high">Fiyat (Yüksek-Düşük)</option>
                        <option value="newest">En Yeniler</option>
                        <option value="popular">En Popüler</option>
                    </select>
                </div>

                <div class="products-grid" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fa-solid fa-box-open"></i>
                    <h3>Ürün bulunamadı</h3>
                    <p>Bu kategoride henüz ürün yok veya filtrelere uygun ürün bulunamadı.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="footer">
        <div class="container footer-inner">
            <div class="footer-col brand-col">
                <div class="footer-logo">
                    <i class="fa-solid fa-heart"></i>
                    <span>Destifo</span>
                </div>
                <p class="footer-desc">Türkiye'nin en büyük sosyal sorumluluk pazar yeri.</p>
            </div>
        </div>
        <div class="footer-bottom container">
            <div class="copyright">© 2024 Destifo Teknoloji A.Ş. Tüm hakları saklıdır.</div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/favorites.js"></script>
    <script>
        // API_BASE is already defined in js/api.js
        let allProducts = [];
        let filteredProducts = [];
        let currentCategoryId = null;
        let currentSubCategoryId = null;

        // Format price
        function formatPrice(price) {
            return price.toLocaleString('tr-TR') + ' TL';
        }

        // Toggle favorite
        async function toggleFavorite(productId, btn) {
            try {
                await FavoritesAPI.toggle(productId);
            } catch (error) {
                Favorites.toggle(productId);
            }

            const icon = btn.querySelector('i');
            icon.classList.toggle('fa-regular');
            icon.classList.toggle('fa-solid');
        }

        // Add to cart
        async function addToCart(productId, btn) {
            try {
                await CartAPI.addItem(productId, 1);
            } catch (error) {
                Cart.addItem(productId, 1);
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Eklendi!';
            btn.style.background = '#27ae60';

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 1500);
        }

        // Render products
        function renderProducts(products) {
            const grid = document.getElementById('productsGrid');
            const emptyState = document.getElementById('emptyState');
            const countEl = document.getElementById('productCount');

            countEl.textContent = `${products.length} ürün`;

            if (products.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = products.map(p => {
                const hasStock = p.stock && p.stock > 0;

                return `
                <div class="product-card">
                    <button class="favorite-btn" onclick="toggleFavorite(${p.id}, this)">
                        <i class="fa-regular fa-heart"></i>
                    </button>
                    <a href="product.html?id=${p.id}">
                        <div class="product-image">
                            <img src="${p.image}" alt="${p.name}">
                            ${!hasStock ? '<div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">Tükendi</div>' : ''}
                        </div>
                        <div class="product-info">
                            <div class="product-brand">${p.brand}</div>
                            <h3 class="product-name">${p.name}</h3>
                            <div class="product-rating">
                                <i class="fa-solid fa-star"></i> ${p.rating || 0} değerlendirme
                            </div>
                            <div class="product-price">${formatPrice(p.price)}</div>
                            ${p.oldPrice ? `<div class="product-old-price">${formatPrice(p.oldPrice)}</div>` : ''}
                        </div>
                    </a>
                    ${hasStock ? `
                        <button class="add-cart-btn" onclick="addToCart(${p.id}, this)">
                            <i class="fa-solid fa-cart-plus"></i> Sepete Ekle
                        </button>
                    ` : `
                        <button class="add-cart-btn" disabled style="background: #e0e0e0; color: #999; cursor: not-allowed;">
                            <i class="fa-solid fa-ban"></i> Stokta Yok
                        </button>
                    `}
                </div>
            `}).join('');
        }

        // Sort products
        function sortProducts() {
            const sort = document.getElementById('sortSelect').value;
            let sorted = [...filteredProducts];

            switch (sort) {
                case 'price-low':
                    sorted.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high':
                    sorted.sort((a, b) => b.price - a.price);
                    break;
                case 'newest':
                    sorted.sort((a, b) => b.id - a.id);
                    break;
                case 'popular':
                    sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
            }

            renderProducts(sorted);
        }

        // Apply filters
        function applyFilters() {
            const selectedBrands = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(cb => cb.value);
            const selectedSubCats = Array.from(document.querySelectorAll('#subCategoryFilters input:checked')).map(cb => parseInt(cb.value));

            filteredProducts = allProducts.filter(product => {
                if (selectedBrands.length > 0 && !selectedBrands.includes(product.brand)) {
                    return false;
                }
                if (selectedSubCats.length > 0 && !selectedSubCats.includes(product.subCategoryId)) {
                    return false;
                }
                return true;
            });

            sortProducts();
        }

        // Apply price filter
        function applyPriceFilter() {
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            filteredProducts = allProducts.filter(product => {
                return product.price >= minPrice && product.price <= maxPrice;
            });

            sortProducts();
        }

        // Populate filters
        function populateFilters(products, subCategories) {
            // Subcategory filters
            const subCatFilters = document.getElementById('subCategoryFilters');
            if (subCategories && subCategories.length > 0) {
                subCatFilters.innerHTML = subCategories.map(sub => `
                    <div class="filter-option">
                        <input type="checkbox" id="sub-${sub.id}" value="${sub.id}" onchange="applyFilters()">
                        <label for="sub-${sub.id}">${sub.name}</label>
                    </div>
                `).join('');
            } else {
                subCatFilters.innerHTML = '<p style="color:#999;font-size:13px;">Alt kategori yok</p>';
            }

            // Brand filters
            const brands = [...new Set(products.map(p => p.brand))];
            const brandFilters = document.getElementById('brandFilters');
            if (brands.length > 0) {
                brandFilters.innerHTML = brands.map(brand => `
                    <div class="filter-option">
                        <input type="checkbox" id="brand-${brand}" value="${brand}" onchange="applyFilters()">
                        <label for="brand-${brand}">${brand}</label>
                    </div>
                `).join('');
            } else {
                brandFilters.innerHTML = '<p style="color:#999;font-size:13px;">Marka yok</p>';
            }
        }

        // Populate subcategory chips
        function populateSubcategoryChips(subCategories, mainCategoryId) {
            const chips = document.getElementById('subcategoryChips');
            if (subCategories && subCategories.length > 0) {
                chips.innerHTML = `<a href="category.html?cat=${mainCategoryId}" class="subcategory-chip active">Tümü</a>` +
                    subCategories.map(sub =>
                        `<a href="category.html?sub=${sub.id}" class="subcategory-chip">${sub.name}</a>`
                    ).join('');
            } else {
                chips.style.display = 'none';
            }
        }

        // Search
        function performSearch() {
            const query = document.getElementById('searchInput').value;
            if (query.trim()) {
                window.location.href = `category.html?search=${encodeURIComponent(query)}`;
            }
        }

        // Load products by category
        async function loadByCategory(categoryId) {
            try {
                const response = await fetch(`${API_BASE}/products/category/${categoryId}`);
                const data = await response.json();

                document.getElementById('page-title').textContent = `${data.mainCategory.name} - Destifo`;
                document.getElementById('category-title').textContent = data.mainCategory.name;
                document.getElementById('category-description').textContent = data.mainCategory.description || 'Bu kategorideki tüm ürünler';
                document.getElementById('breadcrumb-current').textContent = data.mainCategory.name;

                allProducts = data.products;
                filteredProducts = data.products;

                populateFilters(data.products, data.subCategories);
                populateSubcategoryChips(data.subCategories, categoryId);
                renderProducts(filteredProducts);
            } catch (error) {
                console.error('Category load error:', error);
            }
        }

        // Load products by subcategory
        async function loadBySubCategory(subCategoryId) {
            try {
                const response = await fetch(`${API_BASE}/products/subcategory/${subCategoryId}`);
                const data = await response.json();

                const subCat = data.subCategory;

                document.getElementById('page-title').textContent = `${subCat.name} - Destifo`;
                document.getElementById('category-title').textContent = subCat.name;
                document.getElementById('category-description').textContent = `${subCat.main_category_name} kategorisindeki ${subCat.name} ürünleri`;
                document.getElementById('breadcrumb-parent').innerHTML =
                    `<a href="category.html?cat=${subCat.main_category_id}">${subCat.main_category_name}</a> <i class="fa-solid fa-chevron-right"></i>`;
                document.getElementById('breadcrumb-current').textContent = subCat.name;

                allProducts = data.products;
                filteredProducts = data.products;

                populateFilters(data.products, []);
                document.getElementById('subcategoryChips').style.display = 'none';
                renderProducts(filteredProducts);
            } catch (error) {
                console.error('Subcategory load error:', error);
            }
        }

        // Load all products (search or all)
        async function loadAllProducts(searchQuery = null) {
            try {
                const response = await fetch(`${API_BASE}/products`);
                let products = await response.json();

                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    products = products.filter(p =>
                        p.name.toLowerCase().includes(query) ||
                        p.brand.toLowerCase().includes(query)
                    );

                    document.getElementById('page-title').textContent = `"${searchQuery}" araması - Destifo`;
                    document.getElementById('category-title').textContent = `"${searchQuery}" için sonuçlar`;
                    document.getElementById('category-description').textContent = `${products.length} ürün bulundu`;
                    document.getElementById('breadcrumb-current').textContent = 'Arama Sonuçları';
                } else {
                    document.getElementById('category-title').textContent = 'Tüm Ürünler';
                    document.getElementById('category-description').textContent = 'Tüm kategorilerdeki ürünler';
                }

                allProducts = products;
                filteredProducts = products;

                populateFilters(products, []);
                document.getElementById('subcategoryChips').style.display = 'none';
                renderProducts(filteredProducts);
            } catch (error) {
                console.error('Products load error:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('cat');
            const subCategoryId = urlParams.get('sub');
            const searchQuery = urlParams.get('search');

            if (categoryId) {
                await loadByCategory(parseInt(categoryId));
            } else if (subCategoryId) {
                await loadBySubCategory(parseInt(subCategoryId));
            } else if (searchQuery) {
                await loadAllProducts(searchQuery);
            } else {
                await loadAllProducts();
            }

            // Update cart count
            try {
                await CartAPI.updateCartCount();
            } catch (error) {
                console.log('Cart API not available');
            }

            // Search on enter
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
        });
    </script>
</body>

</html>