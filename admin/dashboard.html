<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Destifo Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/modern-admin.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2><i class="fa-solid fa-shield-halved"></i> <span>Destifo Admin</span></h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item active">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="users.html" class="nav-item">
                    <i class="fa-solid fa-users"></i>
                    <span>Kullanıcılar</span>
                </a>
                <a href="stk.html" class="nav-item">
                    <i class="fa-solid fa-building-ngo"></i>
                    <span>STK Başvuruları</span>
                </a>
                <a href="products.html" class="nav-item">
                    <i class="fa-solid fa-box"></i>
                    <span>Ürünler</span>
                </a>
                <a href="campaign-products.html" class="nav-item">
                    <i class="fa-solid fa-fire"></i>
                    <span>Kampanya Ürünleri</span>
                </a>
                <a href="donations.html" class="nav-item">
                    <i class="fa-solid fa-hand-holding-heart"></i>
                    <span>Bağışlar</span>
                </a>
                <a href="orders.html" class="nav-item">
                    <i class="fa-solid fa-shopping-cart"></i>
                    <span>Siparişler</span>
                </a>
                <a href="../index.html" class="nav-item"
                    style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);">
                    <i class="fa-solid fa-external-link-alt"></i>
                    <span>Siteye Git</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1>Dashboard</h1>
                <div class="admin-profile">
                    <span id="adminName">Admin</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fa-solid fa-right-from-bracket"></i> Çıkış
                    </button>
                </div>
            </header>

            <div class="admin-content">
                <!-- User Search Section -->
                <div class="admin-table-container" style="margin-bottom: 24px;">
                    <div class="table-header">
                        <h2><i class="fa-solid fa-search"></i> Kullanıcı Ara</h2>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <input type="text" id="userSearchInput" placeholder="Kullanıcı adı veya e-posta..."
                                style="flex: 1;">
                            <button onclick="searchUser()" class="add-btn">
                                <i class="fa-solid fa-search"></i> Ara
                            </button>
                            <button onclick="clearSearch()" class="action-btn"
                                style="padding: 10px 20px; background: var(--secondary-color); color: white;">
                                <i class="fa-solid fa-times"></i> Temizle
                            </button>
                        </div>
                        <div id="userSearchResults" style="display: none;">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3>Toplam Kullanıcı</h3>
                            <i class="fa-solid fa-users users"></i>
                        </div>
                        <div class="stat-card-value" id="userCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3>Toplam Ürün</h3>
                            <i class="fa-solid fa-box products"></i>
                        </div>
                        <div class="stat-card-value" id="productCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3>Toplam Sipariş</h3>
                            <i class="fa-solid fa-shopping-cart orders"></i>
                        </div>
                        <div class="stat-card-value" id="orderCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3>Toplam Bağış</h3>
                            <i class="fa-solid fa-hand-holding-heart donations"></i>
                        </div>
                        <div class="stat-card-value" id="totalDonation">0 TL</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer; border: 2px solid #e67e22;"
                        onclick="window.location.href='stk.html'">
                        <div class="stat-card-header">
                            <h3 style="color: #e67e22;">STK Başvuruları</h3>
                            <i class="fa-solid fa-building-ngo"
                                style="color: #e67e22; background: rgba(230, 126, 34, 0.1);"></i>
                        </div>
                        <div class="stat-card-value" id="stkRequestCount" style="color: #e67e22;">0</div>
                        <div style="font-size: 12px; color: #e67e22; margin-top: 5px;">Bekleyen Başvurular &rarr;</div>
                    </div>
                </div>

                <!-- System Operations -->
                <div class="admin-table-container" style="margin: 24px 0; border-left: 4px solid var(--danger-color);">
                    <div class="table-header">
                        <h2 style="color: var(--danger-color);"><i class="fa-solid fa-triangle-exclamation"></i> Sistem
                            İşlemleri</h2>
                    </div>
                    <div style="padding: 24px;">
                        <div
                            style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                            <div>
                                <h3 style="margin: 0 0 4px; color: var(--danger-color);">Veri Tabanı Temizliği</h3>
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">Tüm sipariş, bağış
                                    ve sepet verilerini kalıcı olarak siler.</p>
                            </div>
                            <button onclick="openResetModal()" class="action-btn delete"
                                style="padding: 10px 20px; font-size: 0.875rem;">
                                <i class="fa-solid fa-trash-can"></i> Verileri Temizle
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Tables -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Recent Orders -->
                    <div class="admin-table-container">
                        <div class="table-header">
                            <h2>Son Siparişler</h2>
                        </div>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tutar</th>
                                    <th>Durum</th>
                                    <th>Tarih</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrders">
                            </tbody>
                        </table>
                    </div>

                    <!-- Low Stock Products -->
                    <div class="admin-table-container">
                        <div class="table-header">
                            <h2>Düşük Stoklu Ürünler</h2>
                        </div>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Ürün</th>
                                    <th>Stok</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody id="lowStock">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Navigation Categories Management -->
                <div class="admin-table-container" style="margin-top: 20px;">
                    <div class="table-header">
                        <h2><i class="fa-solid fa-bars"></i> Navigasyon Kategorileri</h2>
                        <p style="font-size: 13px; color: #888; margin-top: 5px;">Üst menüde görünecek kategorileri
                            seçin, düzenleyin veya silin</p>
                    </div>
                    <div id="navCategoriesContainer" style="padding: 20px;">
                        <!-- Categories will be loaded here -->
                    </div>
                    <div style="padding: 0 20px 20px;">
                        <button onclick="saveNavCategories()" class="action-btn edit"
                            style="padding: 12px 24px; font-size: 14px;">
                            <i class="fa-solid fa-save"></i> Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Category Products Modal -->
    <div id="categoryProductsModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 16px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div
                style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h3 id="modalCategoryTitle" style="margin: 0;"><i class="fa-solid fa-box"></i> Kategorideki Ürünler</h3>
                <button onclick="closeCategoryModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <div id="categoryProductsList">
                    <!-- Products will be loaded here -->
                </div>
            </div>
            <div style="padding: 15px 20px; border-top: 1px solid #eee; background: #f8f9fa;">
                <p style="margin: 0 0 10px; color: #666; font-size: 13px;">Tüm ürünleri başka kategoriye taşıyın:</p>
                <div style="display: flex; gap: 10px;">
                    <select id="targetCategorySelect"
                        style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <!-- Categories will be loaded here -->
                    </select>
                    <button onclick="moveAllProducts()" class="action-btn edit" style="padding: 10px 20px;">
                        <i class="fa-solid fa-arrows-alt"></i> Tümünü Taşı
                    </button>
                    <button onclick="deleteCategory()" class="action-btn delete"
                        style="padding: 10px 20px; background: #e74c3c;">
                        <i class="fa-solid fa-trash"></i> Kategoriyi Sil
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Data Modal -->
    <div id="resetDataModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 16px; width: 90%; max-width: 500px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="background: var(--danger-color); padding: 20px; color: white;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fa-solid fa-triangle-exclamation"></i> Veri Sıfırlama
                </h3>
                <p style="margin: 5px 0 0; opacity: 0.9; font-size: 13px;">Dikkatli olun, bu işlemler geri alınamaz.</p>
            </div>
            
            <div style="padding: 24px;">
                <label style="display: block; margin-bottom: 15px; font-weight: 600; color: #333;">Sıfırlama Türü:</label>
                
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
                        <input type="radio" name="resetType" value="soft" checked onchange="toggleCustomResetOptions()" style="margin-top: 4px;">
                        <div>
                            <strong style="display: block; color: var(--primary-color);">Soft Reset (Önerilen)</strong>
                            <span style="font-size: 12px; color: #666;">Sadece siparişleri, bağışları ve sepetleri siler. Kullanıcılar ve ürünler kalır.</span>
                        </div>
                    </label>

                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
                        <input type="radio" name="resetType" value="hard" onchange="toggleCustomResetOptions()" style="margin-top: 4px;">
                        <div>
                            <strong style="display: block; color: var(--danger-color);">Hard Reset (Fabrika Ayarları)</strong>
                            <span style="font-size: 12px; color: #666;">HER ŞEYİ siler. Kullanıcılar, STK'lar, ürünler, ayarlar... Sadece Admin kalır.</span>
                        </div>
                    </label>

                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
                        <input type="radio" name="resetType" value="custom" onchange="toggleCustomResetOptions()" style="margin-top: 4px;">
                        <div>
                            <strong style="display: block; color: #333;">Özel Seçim</strong>
                            <span style="font-size: 12px; color: #666;">Silinecek verileri kendiniz seçin.</span>
                        </div>
                    </label>
                </div>

                <!-- Custom Options -->
                <div id="customResetOptions" style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label><input type="checkbox" name="resetTarget" value="orders"> Siparişler</label>
                        <label><input type="checkbox" name="resetTarget" value="donations"> Bağışlar</label>
                        <label><input type="checkbox" name="resetTarget" value="cart"> Sepetler</label>
                        <label><input type="checkbox" name="resetTarget" value="users"> Kullanıcılar</label>
                        <label><input type="checkbox" name="resetTarget" value="products"> Ürünler</label>
                        <label><input type="checkbox" name="resetTarget" value="stk"> STK Başvuruları</label>
                        <label><input type="checkbox" name="resetTarget" value="addresses"> Adresler</label>
                        <label><input type="checkbox" name="resetTarget" value="favorites"> Favoriler</label>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeResetModal()" class="action-btn" style="background: #ccc; color: #333; padding: 10px 20px;">İptal</button>
                    <button onclick="resetDatabase()" class="action-btn delete" style="padding: 10px 20px;">
                        <i class="fa-solid fa-bomb"></i> Sıfırla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        // Check authentication
        if (!localStorage.getItem('admin_token')) {
            window.location.href = 'index.html';
        }

        // Load admin info
        const adminUser = JSON.parse(localStorage.getItem('admin_user') || '{}');
        document.getElementById('adminName').textContent = adminUser.name || 'Admin';

        // Logout
        function logout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            window.location.href = 'index.html';
        }

        // Format date
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR');
        }

        // Search user
        async function searchUser() {
            const query = document.getElementById('userSearchInput').value.trim();
            if (!query) {
                alert('Arama terimi girin!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                const resultsDiv = document.getElementById('userSearchResults');

                if (!data.users || data.users.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Kullanıcı bulunamadı</p>';
                    resultsDiv.style.display = 'block';
                    return;
                }

                resultsDiv.innerHTML = data.users.map(user => `
                    <div style="background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: #1e3a5f;">${user.first_name} ${user.last_name}</h3>
                                <p style="margin: 5px 0 0; color: #888; font-size: 13px;">${user.email} • ${user.phone || 'Telefon yok'}</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <span style="background: ${user.is_blocked ? '#e74c3c' : '#27ae60'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                    ${user.is_blocked ? 'Engelli' : 'Aktif'}
                                </span>
                                <span style="background: #f0f0f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                    Kayıt: ${formatDate(user.created_at)}
                                </span>
                            </div>
                        </div>
                        
                        <!-- User Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: #1976d2;">${user.stats.totalOrders}</div>
                                <div style="font-size: 11px; color: #666;">Sipariş</div>
                            </div>
                            <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: #388e3c;">${user.stats.totalSpent.toLocaleString('tr-TR')} ₺</div>
                                <div style="font-size: 11px; color: #666;">Harcama</div>
                            </div>
                            <div style="background: #fff3e0; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: #f57c00;">${user.stats.totalDonations.toLocaleString('tr-TR')} ₺</div>
                                <div style="font-size: 11px; color: #666;">Bağış</div>
                            </div>
                            <div style="background: #fce4ec; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: #c2185b;">${user.stats.totalFavorites}</div>
                                <div style="font-size: 11px; color: #666;">Favori</div>
                            </div>
                        </div>

                        <!-- Orders -->
                        ${user.orders.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px; font-size: 14px; color: #1e3a5f;"><i class="fa-solid fa-shopping-cart"></i> Siparişler</h4>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${user.orders.map(o => `
                                    <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 5px; font-size: 13px;">
                                        <span>#${o.id} - ${o.status}</span>
                                        <span>${o.total_amount} TL - ${formatDate(o.created_at)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Donations -->
                        ${user.donations.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px; font-size: 14px; color: #e67e22;"><i class="fa-solid fa-hand-holding-heart"></i> Bağışlar</h4>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${user.donations.map(d => `
                                    <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: #fff8e1; border-radius: 6px; margin-bottom: 5px; font-size: 13px;">
                                        <span>${d.ngo_name || 'STK'}</span>
                                        <span>${d.amount} TL - ${formatDate(d.created_at)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Favorites -->
                        ${user.favorites.length > 0 ? `
                        <div>
                            <h4 style="margin: 0 0 10px; font-size: 14px; color: #e74c3c;"><i class="fa-solid fa-heart"></i> Favoriler</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${user.favorites.slice(0, 6).map(f => `
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: #fce4ec; border-radius: 6px; font-size: 12px;">
                                        <img src="${f.image}" style="width: 24px; height: 24px; object-fit: cover; border-radius: 4px;">
                                        <span>${f.product_name.substring(0, 20)}...</span>
                                    </div>
                                `).join('')}
                                ${user.favorites.length > 6 ? `<span style="color: #888; font-size: 12px;">+${user.favorites.length - 6} daha</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `).join('');

                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Search error:', error);
                alert('Arama sırasında hata oluştu!');
            }
        }

        // Clear search
        function clearSearch() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').style.display = 'none';
            document.getElementById('userSearchResults').innerHTML = '';
        }

        // Enter key search
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('userSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchUser();
            });
        });

        // Load dashboard data
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/dashboard`);
                const data = await response.json();

                // Update stats
                document.getElementById('userCount').textContent = data.stats.users;
                document.getElementById('productCount').textContent = data.stats.products;
                document.getElementById('orderCount').textContent = data.stats.orders;
                document.getElementById('totalDonation').textContent = data.stats.donations;

                // Recent orders
                const ordersBody = document.getElementById('recentOrders');
                if (data.recentOrders.length > 0) {
                    ordersBody.innerHTML = data.recentOrders.map(order => `
                        <tr>
                            <td>#${order.id}</td>
                            <td>${order.total_amount}</td>
                            <td><span class="status-badge ${order.status}">${order.status}</span></td>
                            <td>${formatDate(order.created_at)}</td>
                        </tr>
                    `).join('');
                } else {
                    ordersBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;">Sipariş bulunamadı</td></tr>';
                }

                // Low stock
                const lowStockBody = document.getElementById('lowStock');
                if (data.lowStock.length > 0) {
                    lowStockBody.innerHTML = data.lowStock.map(product => `
                        <tr>
                            <td>${product.name}</td>
                            <td><strong style="color: ${product.stock < 5 ? 'red' : 'orange'}">${product.stock}</strong></td>
                            <td><a href="products.html" class="action-btn edit">Stok Güncelle</a></td>
                        </tr>
                    `).join('');
                } else {
                    lowStockBody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:30px;">Düşük stoklu ürün yok</td></tr>';
                }

                // Load nav categories
                await loadNavCategories();
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        // Available icons for categories
        const availableIcons = [
            { icon: 'fa-venus', label: 'Kadın' },
            { icon: 'fa-mars', label: 'Erkek' },
            { icon: 'fa-child', label: 'Çocuk' },
            { icon: 'fa-spray-can-sparkles', label: 'Kozmetik' },
            { icon: 'fa-home', label: 'Ev' },
            { icon: 'fa-laptop', label: 'Laptop' },
            { icon: 'fa-mobile', label: 'Telefon' },
            { icon: 'fa-shirt', label: 'Giyim' },
            { icon: 'fa-shoe-prints', label: 'Ayakkabı' },
            { icon: 'fa-bag-shopping', label: 'Çanta' },
            { icon: 'fa-gem', label: 'Mücevher' },
            { icon: 'fa-gamepad', label: 'Oyun' },
            { icon: 'fa-book', label: 'Kitap' },
            { icon: 'fa-utensils', label: 'Yemek' },
            { icon: 'fa-dumbbell', label: 'Spor' },
            { icon: 'fa-car', label: 'Araba' },
            { icon: 'fa-paw', label: 'Evcil' },
            { icon: 'fa-couch', label: 'Mobilya' },
            { icon: 'fa-tv', label: 'TV' },
            { icon: 'fa-headphones', label: 'Kulaklık' },
            { icon: 'fa-camera', label: 'Kamera' },
            { icon: 'fa-gift', label: 'Hediye' },
            { icon: 'fa-folder', label: 'Klasör' }
        ];

        // Load navigation categories
        async function loadNavCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const categories = await response.json();

                // Get saved nav settings from localStorage
                const savedNavCats = JSON.parse(localStorage.getItem('destifo_nav_categories') || '["kadin","erkek","cocuk","kozmetik","ev-yasam","elektronik"]');
                const savedNavCustom = JSON.parse(localStorage.getItem('destifo_nav_custom') || '{}');

                const iconOptions = availableIcons.map(i => `<option value="${i.icon}">${i.label}</option>`).join('');

                const container = document.getElementById('navCategoriesContainer');
                container.innerHTML = categories.map(cat => {
                    const customName = savedNavCustom[cat.slug]?.name || cat.name;
                    const customIcon = savedNavCustom[cat.slug]?.icon || '';

                    return `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 12px;" data-category-id="${cat.id}">
                        <input type="checkbox" name="navCategory" value="${cat.slug}" data-cat-id="${cat.id}" ${savedNavCats.includes(cat.slug) ? 'checked' : ''} 
                            style="width: 20px; height: 20px; accent-color: var(--primary-color); flex-shrink: 0;">
                        
                        <select name="navIcon_${cat.slug}" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; min-width: 120px;">
                            <option value="">Varsayılan İkon</option>
                            ${availableIcons.map(i => `<option value="${i.icon}" ${customIcon === i.icon ? 'selected' : ''}>${i.label}</option>`).join('')}
                        </select>
                        
                        <input type="text" name="navName_${cat.slug}" value="${customName}" placeholder="Kategori Adı"
                            style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        
                        <span style="color: #888; font-size: 12px; min-width: 80px;">${cat.slug}</span>
                        
                        <button onclick="openCategoryModal(${cat.id}, '${cat.name}')" class="action-btn delete" 
                            style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            <i class="fa-solid fa-trash"></i> Sil
                        </button>
                    </div>
                `}).join('');

                // Store categories globally for modal
                window.allCategories = categories;
            } catch (error) {
                console.error('Nav categories error:', error);
            }
        }

        // Current category being edited
        let currentCategoryId = null;
        let currentCategoryName = '';

        // Open category modal
        async function openCategoryModal(categoryId, categoryName) {
            currentCategoryId = categoryId;
            currentCategoryName = categoryName;

            document.getElementById('modalCategoryTitle').innerHTML = `<i class="fa-solid fa-box"></i> ${categoryName} Kategorisindeki Ürünler`;

            // Load products in this category
            try {
                const response = await fetch(`${API_BASE}/admin/categories/${categoryId}/products`);
                const products = await response.json();

                const productsList = document.getElementById('categoryProductsList');

                if (products.length === 0) {
                    productsList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Bu kategoride ürün yok. Kategoriyi doğrudan silebilirsiniz.</p>';
                } else {
                    productsList.innerHTML = products.map(p => `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px;">
                            <img src="${p.image}" alt="${p.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                            <div style="flex: 1;">
                                <strong>${p.name}</strong>
                                <div style="font-size: 12px; color: #888;">${p.price} TL</div>
                            </div>
                            <select onchange="updateProductCategory(${p.id}, this.value)" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                ${window.allCategories.map(c => `<option value="${c.id}" ${c.id === p.main_category_id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </div>
                    `).join('');
                }

                // Load target category select
                const targetSelect = document.getElementById('targetCategorySelect');
                targetSelect.innerHTML = window.allCategories
                    .filter(c => c.id !== categoryId)
                    .map(c => `<option value="${c.id}">${c.name}</option>`)
                    .join('');

                // Show modal
                document.getElementById('categoryProductsModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Ürünler yüklenirken hata oluştu!');
            }
        }

        // Close modal
        function closeCategoryModal() {
            document.getElementById('categoryProductsModal').style.display = 'none';
            currentCategoryId = null;
        }

        // Update single product category
        async function updateProductCategory(productId, newCategoryId) {
            try {
                const response = await fetch(`${API_BASE}/admin/products/${productId}/category`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ main_category_id: parseInt(newCategoryId), sub_category_id: null })
                });

                if (response.ok) {
                    // Refresh the modal
                    openCategoryModal(currentCategoryId, currentCategoryName);
                }
            } catch (error) {
                console.error('Error updating product:', error);
            }
        }

        // Move all products to another category
        async function moveAllProducts() {
            const targetCategoryId = document.getElementById('targetCategorySelect').value;
            if (!targetCategoryId) {
                alert('Hedef kategori seçin!');
                return;
            }

            if (!confirm('Tüm ürünler seçilen kategoriye taşınacak. Emin misiniz?')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/categories/${currentCategoryId}/products`);
                const products = await response.json();

                for (const product of products) {
                    await fetch(`${API_BASE}/admin/products/${product.id}/category`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ main_category_id: parseInt(targetCategoryId), sub_category_id: null })
                    });
                }

                alert('Tüm ürünler taşındı!');
                openCategoryModal(currentCategoryId, currentCategoryName);
            } catch (error) {
                console.error('Error moving products:', error);
                alert('Hata oluştu!');
            }
        }

        // Delete category
        async function deleteCategory() {
            if (!confirm(`"${currentCategoryName}" kategorisini silmek istediğinize emin misiniz?`)) return;

            try {
                const response = await fetch(`${API_BASE}/admin/categories/${currentCategoryId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    alert(result.message || result.error);
                    return;
                }

                alert('Kategori silindi!');
                closeCategoryModal();
                loadNavCategories();
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('Hata oluştu!');
            }
        }

        // Save navigation categories
        function saveNavCategories() {
            const checkboxes = document.querySelectorAll('input[name="navCategory"]:checked');
            const selectedSlugs = Array.from(checkboxes).map(cb => cb.value);

            if (selectedSlugs.length === 0) {
                alert('En az bir kategori seçmelisiniz!');
                return;
            }

            // Collect custom names and icons
            const customSettings = {};
            document.querySelectorAll('input[name="navCategory"]').forEach(cb => {
                const slug = cb.value;
                const nameInput = document.querySelector(`input[name="navName_${slug}"]`);
                const iconSelect = document.querySelector(`select[name="navIcon_${slug}"]`);

                if (nameInput || iconSelect) {
                    customSettings[slug] = {
                        name: nameInput?.value || '',
                        icon: iconSelect?.value || ''
                    };
                }
            });

            localStorage.setItem('destifo_nav_categories', JSON.stringify(selectedSlugs));
            localStorage.setItem('destifo_nav_custom', JSON.stringify(customSettings));
            alert('Navigasyon kategorileri kaydedildi! Ana sayfayı yenileyince değişiklikler görünecek.');
        }

        // Open Reset Modal
        function openResetModal() {
            document.getElementById('resetDataModal').style.display = 'flex';
        }

        function closeResetModal() {
            document.getElementById('resetDataModal').style.display = 'none';
        }

        // Toggle Custom Options
        function toggleCustomResetOptions() {
            const isCustom = document.querySelector('input[name="resetType"][value="custom"]').checked;
            document.getElementById('customResetOptions').style.display = isCustom ? 'block' : 'none';
        }

        // Reset Database
        async function resetDatabase() {
            const resetType = document.querySelector('input[name="resetType"]:checked').value;
            let targets = [];

            if (resetType === 'custom') {
                document.querySelectorAll('input[name="resetTarget"]:checked').forEach(cb => {
                    targets.push(cb.value);
                });
                if (targets.length === 0) {
                    alert('En az bir veri türü seçmelisiniz.');
                    return;
                }
            }

            if (!confirm('DİKKAT! Bu işlem seçilen verileri kalıcı olarak silecektir. Onaylıyor musunuz?')) return;
            
            // Double confirm for hard reset
            if (resetType === 'hard' && !confirm('HARD RESET: Tüm kullanıcılar ve STK hesapları da silinecek. Emin misiniz?')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/reset-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                    body: JSON.stringify({ type: resetType, targets })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    closeResetModal();
                    window.location.reload();
                } else {
                    alert('Hata: ' + (result.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('Reset error:', error);
                alert('İşlem sırasında bir hata oluştu.');
            }
        }

        document.addEventListener('DOMContentLoaded', loadDashboard);

        // Load STK Stats independently
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_BASE}/admin/stk-applications`);
                const data = await response.json();
                if (data.success && data.applications) {
                    const pending = data.applications.filter(a => a.status === 'pending').length;
                    document.getElementById('stkRequestCount').textContent = pending;
                }
            } catch (error) {
                console.error('Error loading STK stats:', error);
                document.getElementById('stkRequestCount').textContent = '-';
            }
        });
    </script>
</body>

</html>