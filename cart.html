<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepetim - Destifo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/products.css">
    <link rel="stylesheet" href="css/pages.css">
</head>

<body>

    <!-- Fixed Header Wrapper -->
    <div class="fixed-header-wrapper">
        <!-- Header Section -->
        <header class="header">
            <div class="container header-inner">
                <div class="logo">
                    <a href="index.html"
                        style="display: flex; align-items: center; color: inherit; text-decoration: none;">
                        <img src="images/logo.png" alt="Destifo Logo" style="height: 40px; margin-right: 8px;">
                        <span class="logo-text">Destifo</span>
                    </a>
                </div>

                <div class="search-bar">
                    <input type="text" placeholder="√úr√ºn, kategori veya baƒüƒ±≈ü kurumu ara...">
                    <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>

                <div class="header-actions">
                    <a href="account.html" class="action-item">
                        <i class="fa-solid fa-user"></i>
                        <span>Hesabƒ±m</span>
                    </a>
                    <a href="favorites.html" class="action-item">
                        <i class="fa-solid fa-heart"></i>
                        <span>Favorilerim</span>
                    </a>
                    <a href="cart.html" class="action-item">
                        <div class="cart-icon-wrapper">
                            <i class="fa-solid fa-cart-shopping"></i>
                            <span class="cart-count">0</span>
                        </div>
                        <span>Sepetim</span>
                    </a>
                </div>
            </div>
        </header>
    </div>

    <!-- Breadcrumbs -->
    <div class="breadcrumbs container">
        <a href="index.html">Anasayfa</a> <i class="fa-solid fa-chevron-right"></i>
        <span class="current">Sepetim</span>
    </div>

    <!-- Cart Section -->
    <section class="cart-section container">
        <div class="cart-content">
            <div class="cart-items-wrapper">
                <h2 class="section-title">Sepetim</h2>

                <div id="cart-items" class="cart-items">
                    <!-- Cart items will be loaded here by JavaScript -->
                </div>

                <!-- DONATION SELECTION SECTION -->
                <div id="donation-section" class="donation-selection-section"
                    style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #e8f5e9 0%, #fff8e1 100%); border-radius: 16px; border: 2px solid #4caf50; display: none;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
                        <div
                            style="width: 50px; height: 50px; background: linear-gradient(135deg, #4caf50, #8bc34a); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-hand-holding-heart" style="color: white; font-size: 22px;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #2e7d32; font-size: 1.2rem;">Baƒüƒ±≈ü Yapmak ƒ∞ster Misiniz?</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">Sipari≈üinize ekstra baƒüƒ±≈ü
                                ekleyebilirsiniz</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Baƒüƒ±≈ü Kurulu≈üu
                            Se√ßin</label>
                        <select id="donation-org"
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; background: white; cursor: pointer;">
                            <option value="">-- Kurulu≈ü Se√ß --</option>
                            <option value="TEGV">üìö TEGV - T√ºrkiye Eƒüitim G√∂n√ºll√ºleri</option>
                            <option value="TEMA">üå≥ TEMA - T√ºrkiye Erozyonla M√ºcadele</option>
                            <option value="LOSEV">üíú L√ñSEV - L√∂semili √áocuklar Vakfƒ±</option>
                            <option value="KIZILAY">üåô T√ºrk Kƒ±zƒ±lay</option>
                            <option value="UNICEF">ü¶ã UNICEF T√ºrkiye</option>
                            <option value="AHBAP">ü§ù AHBAP Derneƒüi</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Baƒüƒ±≈ü
                            Miktarƒ±</label>
                        <div id="donation-amounts" style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <button type="button" class="donation-amount-btn" data-amount="5"
                                style="flex: 1; min-width: 70px; padding: 12px 16px; border: 2px solid #4caf50; background: white; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">5
                                ‚Ç∫</button>
                            <button type="button" class="donation-amount-btn" data-amount="10"
                                style="flex: 1; min-width: 70px; padding: 12px 16px; border: 2px solid #4caf50; background: white; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">10
                                ‚Ç∫</button>
                            <button type="button" class="donation-amount-btn" data-amount="25"
                                style="flex: 1; min-width: 70px; padding: 12px 16px; border: 2px solid #4caf50; background: white; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">25
                                ‚Ç∫</button>
                            <button type="button" class="donation-amount-btn" data-amount="50"
                                style="flex: 1; min-width: 70px; padding: 12px 16px; border: 2px solid #4caf50; background: white; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">50
                                ‚Ç∫</button>
                            <button type="button" class="donation-amount-btn" data-amount="100"
                                style="flex: 1; min-width: 70px; padding: 12px 16px; border: 2px solid #4caf50; background: white; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">100
                                ‚Ç∫</button>
                        </div>
                        <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="custom-donation" placeholder="√ñzel miktar..." min="1"
                                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem;">
                            <span style="color: #666;">‚Ç∫</span>
                        </div>
                    </div>

                    <div id="donation-preview"
                        style="display: none; padding: 12px; background: white; border-radius: 10px; border-left: 4px solid #4caf50;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: #2e7d32;" id="preview-org">TEGV</span>
                                <span style="color: #666;"> kurulusuna </span>
                            </div>
                            <span style="font-size: 1.3rem; font-weight: 700; color: #4caf50;" id="preview-amount">25
                                ‚Ç∫</span>
                        </div>
                    </div>

                    <button type="button" id="clear-donation-btn"
                        style="display: none; margin-top: 10px; padding: 8px 16px; background: #f5f5f5; border: none; border-radius: 8px; color: #666; cursor: pointer; font-size: 0.9rem;">
                        <i class="fa-solid fa-times"></i> Baƒüƒ±≈üƒ± Kaldƒ±r
                    </button>
                </div>

                <div id="empty-cart" class="empty-state" style="display: none;">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <h3>Sepetiniz Bo≈ü</h3>
                    <p>Sepetinizde hen√ºz √ºr√ºn bulunmuyor. Alƒ±≈üveri≈üe ba≈ülamak i√ßin √ºr√ºnlerimize g√∂z atƒ±n.</p>
                    <a href="index.html" class="btn-primary">Alƒ±≈üveri≈üe Ba≈üla</a>
                </div>
            </div>

            <div class="cart-summary" id="cart-summary">
                <h3>Sipari≈ü √ñzeti</h3>
                <div class="summary-row">
                    <span>√úr√ºn Toplamƒ±</span>
                    <span id="subtotal">0,00 TL</span>
                </div>
                <div class="summary-row">
                    <span>Kargo</span>
                    <span class="free-shipping">√úcretsiz</span>
                </div>
                <div class="summary-row donation-row">
                    <span><i class="fa-solid fa-heart"></i> Toplam Baƒüƒ±≈ü</span>
                    <span id="donation-total">0,00 TL</span>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-row total-row">
                    <span>Genel Toplam</span>
                    <span id="grand-total">0,00 TL</span>
                </div>
                <button class="checkout-btn">
                    <i class="fa-solid fa-lock"></i> G√ºvenli √ñdemeye Ge√ß
                </button>
                <p class="checkout-note">
                    <i class="fa-solid fa-shield-halved"></i> 256-bit SSL ile g√ºvenli √∂deme
                </p>
            </div>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="footer">
        <div class="container footer-inner">
            <div class="footer-col brand-col">
                <div class="footer-logo">
                    <i class="fa-solid fa-heart"></i>
                    <span>Destifo</span>
                </div>
                <p class="footer-desc">T√ºrkiye'nin en b√ºy√ºk sosyal sorumluluk pazar yeri. Alƒ±≈üveri≈ü alƒ±≈ükanlƒ±klarƒ±nƒ±
                    iyiliƒüe d√∂n√º≈üt√ºr√ºyoruz.</p>
            </div>

            <div class="footer-col">
                <h4>Destifo</h4>
                <ul>
                    <li><a href="#">Hakkƒ±mƒ±zda</a></li>
                    <li><a href="#">Kariyer</a></li>
                    <li><a href="#">S√ºrd√ºr√ºlebilirlik</a></li>
                    <li><a href="#">ƒ∞leti≈üim</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>M√º≈üteri Hizmetleri</h4>
                <ul>
                    <li><a href="#">Sƒ±k√ßa Sorulan Sorular</a></li>
                    <li><a href="#">Canlƒ± Destek</a></li>
                    <li><a href="#">ƒ∞ade ve ƒ∞ptal</a></li>
                    <li><a href="#">ƒ∞≈ülem Rehberi</a></li>
                </ul>
            </div>

            <div class="footer-col campaigns-col">
                <h4>Kampanyalar</h4>
                <div class="footer-campaign-card">
                    <i class="fa-solid fa-graduation-cap"></i>
                    <div>
                        <span>Eƒüitim Seferberliƒüi</span>
                        <a href="#">Detaylƒ± Bilgi ></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom container">
            <div class="copyright">¬© 2024 Destifo Teknoloji A.≈û. T√ºm haklarƒ± saklƒ±dƒ±r.</div>
            <div class="footer-links">
                <a href="#">Gizlilik Politikasƒ±</a>
                <a href="#">Kullanƒ±m Ko≈üullarƒ±</a>
                <a href="#">√áerez Politikasƒ±</a>
            </div>
        </div>
    </footer>

    <!-- VALIDATION MODAL -->
    <div id="validationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Eksik Se√ßenekler</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">Sepetinizdeki bazƒ± √ºr√ºnler i√ßin se√ßenek (renk, beden vb.)
                    belirtilmemi≈ü. Devam etmek i√ßin l√ºtfen se√ßim yapƒ±nƒ±z.</p>
                <div id="validationList" class="validation-list">
                    <!-- Items injected here -->
                </div>
                <button id="saveVariantsBtn" class="btn-primary" style="width: 100%; margin-top: 20px;">Se√ßimleri
                    Kaydet</button>
            </div>
        </div>
    </div>

    <script src="js/products_data.js"></script>
    <script src="js/api.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/favorites.js"></script>
    <script>
        // Render cart page
        document.addEventListener('DOMContentLoaded', () => {
            const cartItemsContainer = document.getElementById('cart-items');
            const emptyCart = document.getElementById('empty-cart');
            const cartSummary = document.getElementById('cart-summary');
            const subtotalEl = document.getElementById('subtotal');
            const donationEl = document.getElementById('donation-total');
            const grandTotalEl = document.getElementById('grand-total');

            async function renderCart() {
                let items = [];
                let isApi = false;

                if (window.CartAPI) {
                    try {
                        items = await window.CartAPI.getItems();
                        isApi = true;
                    } catch (e) {
                        // Fallback to local
                        items = Cart.getItems();
                        isApi = false;
                    }
                } else {
                    items = Cart.getItems();
                }

                if (items.length === 0) {
                    cartItemsContainer.style.display = 'none';
                    cartSummary.style.display = 'none';
                    emptyCart.style.display = 'flex';
                    return;
                }

                cartItemsContainer.style.display = 'block';
                cartSummary.style.display = 'block';
                emptyCart.style.display = 'none';

                let subtotal = 0;
                let html = '';

                items.forEach(item => {
                    let product;

                    if (isApi) {
                        // Item from API contains product details directly
                        product = {
                            id: item.product_id,
                            title: item.title,
                            brand: item.brand,
                            price: item.price,
                            image: item.image,
                            quantity: item.quantity,
                            cartItemId: item.id
                        };
                    } else {
                        // Item from LocalStorage contains only productId, need lookup
                        const p = products.find(p => p.id === item.productId);
                        if (p) {
                            product = {
                                ...p,
                                quantity: item.quantity
                            };
                        }
                    }

                    if (product) {
                        let priceNum;
                        let displayPrice;

                        if (typeof product.price === 'number') {
                            priceNum = product.price;
                            displayPrice = priceNum.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' TL';
                        } else {
                            // Assume string "899,90 TL"
                            priceNum = parseFloat(product.price.replace('.', '').replace(',', '.').replace(' TL', ''));
                            displayPrice = product.price;
                        }

                        const itemTotal = priceNum * product.quantity;
                        subtotal += itemTotal;

                        // Get selected variants from API item
                        const selectedColor = item.selected_color || '';
                        const selectedSize = item.selected_size || '';
                        const selectedMemory = item.selected_memory || '';
                        const selectedAttributes = item.selected_attributes || {};

                        // Build variant badges dynamically
                        let variantHtml = '';
                        if (selectedColor) variantHtml += `<span class="variant-badge" style="background:#e74c3c;color:white;padding:4px 10px;border-radius:6px;margin-right:6px;font-size:12px;display:inline-block;margin-bottom:4px;">Renk: ${selectedColor}</span>`;
                        if (selectedSize) variantHtml += `<span class="variant-badge" style="background:#3498db;color:white;padding:4px 10px;border-radius:6px;margin-right:6px;font-size:12px;display:inline-block;margin-bottom:4px;">Beden: ${selectedSize}</span>`;
                        if (selectedMemory) variantHtml += `<span class="variant-badge" style="background:#9b59b6;color:white;padding:4px 10px;border-radius:6px;margin-right:6px;font-size:12px;display:inline-block;margin-bottom:4px;">Hafƒ±za: ${selectedMemory}</span>`;

                        // Add dynamic attributes
                        if (selectedAttributes && typeof selectedAttributes === 'object') {
                            const colors = ['#16a085', '#e67e22', '#f39c12', '#8e44ad'];
                            let colorIndex = 0;
                            for (const [key, value] of Object.entries(selectedAttributes)) {
                                if (key === 'Renk' && selectedColor) continue;
                                if (key === 'Beden' && selectedSize) continue;
                                if (key === 'Hafƒ±za' && selectedMemory) continue;
                                const bgColor = colors[colorIndex % colors.length];
                                variantHtml += `<span class="variant-badge" style="background:${bgColor};color:white;padding:4px 10px;border-radius:6px;margin-right:6px;font-size:12px;display:inline-block;margin-bottom:4px;">${key}: ${value}</span>`;
                                colorIndex++;
                            }
                        }

                        html += `
                            <div class="cart-item" data-id="${product.id}" data-cart-id="${item.id || ''}">
                                <a href="product.html?id=${product.id}" style="text-decoration: none;">
                                    <img src="${product.image}" alt="${product.title}" class="cart-item-image" style="cursor: pointer;">
                                </a>
                                <div class="cart-item-details">
                                    <span class="cart-item-brand">${product.brand}</span>
                                    <a href="product.html?id=${product.id}" style="text-decoration: none; color: inherit;">
                                        <h4 class="cart-item-title" style="cursor: pointer; transition: color 0.2s;" onmouseover="this.style.color='var(--primary-color)'" onmouseout="this.style.color='inherit'">${product.title}</h4>
                                    </a>
                                    ${variantHtml ? `<div class="cart-item-variants" style="margin-top:8px; margin-bottom:8px;">${variantHtml}</div>` : ''}
                                    <div class="cart-item-price">${displayPrice}</div>
                                </div>
                                <div class="cart-item-quantity">
                                    <button class="qty-btn minus" onclick="updateQty(${product.id}, -1)">-</button>
                                    <span class="qty-value">${product.quantity}</span>
                                    <button class="qty-btn plus" onclick="updateQty(${product.id}, 1)">+</button>
                                </div>
                                <button class="remove-item" onclick="removeFromCart(${product.id})">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                });

                cartItemsContainer.innerHTML = html;

                // Calculate totals
                const donation = subtotal * 0.15;
                const grandTotal = subtotal;

                subtotalEl.textContent = subtotal.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' TL';
                donationEl.textContent = donation.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' TL';
                grandTotalEl.textContent = grandTotal.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' TL';
            }

            window.updateQty = async function (productId, delta) {
                if (window.CartAPI) {
                    const items = await window.CartAPI.getItems();
                    const item = items.find(i => (i.product_id || i.productId) === productId);
                    if (item) {
                        const newQty = item.quantity + delta;
                        if (newQty > 0) {
                            await window.CartAPI.updateQuantity(productId, newQty);
                        } else {
                            await window.CartAPI.removeItem(productId);
                        }
                        renderCart();
                    }
                } else {
                    const items = Cart.getItems();
                    const item = items.find(i => i.productId === productId);
                    if (item) {
                        const newQty = item.quantity + delta;
                        if (newQty > 0) {
                            Cart.updateQuantity(productId, newQty);
                        } else {
                            Cart.removeItem(productId);
                        }
                        renderCart();
                    }
                }
            };

            window.removeFromCart = async function (productId) {
                if (window.CartAPI) {
                    await window.CartAPI.removeItem(productId);
                } else {
                    Cart.removeItem(productId);
                }
                renderCart();
            };

            // ============ DONATION LOGIC ============
            const donationSection = document.getElementById('donation-section');
            const donationOrgSelect = document.getElementById('donation-org');
            const donationAmountBtns = document.querySelectorAll('.donation-amount-btn');
            const customDonationInput = document.getElementById('custom-donation');
            const donationPreview = document.getElementById('donation-preview');
            const previewOrg = document.getElementById('preview-org');
            const previewAmount = document.getElementById('preview-amount');
            const clearDonationBtn = document.getElementById('clear-donation-btn');

            let selectedDonationAmount = 0;
            let selectedDonationOrg = '';

            function updateDonationUI() {
                // Update preview
                if (selectedDonationOrg && selectedDonationAmount > 0) {
                    previewOrg.textContent = selectedDonationOrg;
                    previewAmount.textContent = selectedDonationAmount + ' ‚Ç∫';
                    donationPreview.style.display = 'block';
                    clearDonationBtn.style.display = 'inline-block';
                } else {
                    donationPreview.style.display = 'none';
                    clearDonationBtn.style.display = 'none';
                }

                // Get current subtotal
                const subtotalText = subtotalEl.textContent.replace('.', '').replace(',', '.').replace(' TL', '');
                const subtotalVal = parseFloat(subtotalText) || 0;

                // Calculate product donation (15% of subtotal)
                const productDonation = subtotalVal * 0.15;

                // Total donation = Product Percentage + Extra Selected
                const totalDonationToShow = productDonation + selectedDonationAmount;

                // Update cart summary donation total
                donationEl.textContent = totalDonationToShow.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' TL';

                // Update grand total (subtotal + EXTRA donation only)
                // Product donation is already inside subtotal logic (informational)
                const newGrandTotal = subtotalVal + selectedDonationAmount;
                grandTotalEl.textContent = newGrandTotal.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' TL';

                // Save to localStorage for payment page
                if (selectedDonationAmount > 0 && selectedDonationOrg) {
                    localStorage.setItem('destifo_cart_donation', JSON.stringify({
                        amount: selectedDonationAmount,
                        organization: selectedDonationOrg
                    }));
                } else {
                    localStorage.removeItem('destifo_cart_donation');
                }
            }

            // Amount button clicks
            donationAmountBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Deselect all
                    donationAmountBtns.forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#333';
                    });
                    // Select this one
                    btn.style.background = '#4caf50';
                    btn.style.color = 'white';
                    selectedDonationAmount = parseInt(btn.dataset.amount);
                    customDonationInput.value = '';
                    updateDonationUI();
                });
            });

            // Custom amount input
            customDonationInput.addEventListener('input', () => {
                const val = parseInt(customDonationInput.value) || 0;
                // Deselect preset buttons
                donationAmountBtns.forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#333';
                });
                selectedDonationAmount = val;
                updateDonationUI();
            });

            // Org selection
            donationOrgSelect.addEventListener('change', () => {
                selectedDonationOrg = donationOrgSelect.value;
                updateDonationUI();
            });

            // Clear donation
            clearDonationBtn.addEventListener('click', () => {
                selectedDonationAmount = 0;
                selectedDonationOrg = '';
                donationOrgSelect.value = '';
                customDonationInput.value = '';
                donationAmountBtns.forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#333';
                });
                updateDonationUI();
            });

            // Show donation section when cart has items (called in renderCart)
            function showDonationSection(hasItems) {
                if (donationSection) {
                    donationSection.style.display = hasItems ? 'block' : 'none';
                }
            }

            // Load saved donation from localStorage
            const savedDonation = JSON.parse(localStorage.getItem('destifo_cart_donation') || 'null');
            if (savedDonation) {
                selectedDonationAmount = savedDonation.amount;
                selectedDonationOrg = savedDonation.organization;
                donationOrgSelect.value = savedDonation.organization;
                // Highlight matching button if exists
                donationAmountBtns.forEach(btn => {
                    if (parseInt(btn.dataset.amount) === savedDonation.amount) {
                        btn.style.background = '#4caf50';
                        btn.style.color = 'white';
                    }
                });
                if (!Array.from(donationAmountBtns).find(b => parseInt(b.dataset.amount) === savedDonation.amount)) {
                    customDonationInput.value = savedDonation.amount;
                }
            }

            // Patch renderCart to show/hide donation section
            const originalRenderCart = renderCart;
            renderCart = async function () {
                await originalRenderCart();
                // Check if cart has items
                const items = window.CartAPI ? await window.CartAPI.getItems() : Cart.getItems();
                showDonationSection(items.length > 0);
                updateDonationUI();
            };

            renderCart();
        });
    </script>
</body>

</html>